<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Music</title>
    <link rel="icon" href="image/clover.png" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <link rel="stylesheet" href="assets/style.css" />
  </head>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: "JetBrains Mono", monospace;
      height: 100vh;
      background: linear-gradient(135deg, #1e3c72, #2a5298);
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      overflow: hidden;
      touch-action: manipulation;
    }

    .background-blur {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-size: cover;
      background-position: center;
      filter: blur(20px);
      transform: scale(1.1);
      transition: background-image 1s ease-in-out;
      z-index: -2;
    }

    .overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      z-index: -1;
    }

    .music-player {
      padding: 40px;
      width: 450px;
      text-align: center;
      color: white;
      position: relative;
      z-index: 1;
    }

    .song-info {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .album-art {
      width: 120px;
      height: 120px;
      border-radius: 15px;
      object-fit: cover;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      transition: transform 0.3s ease;
      background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 2rem;
      background-size: cover;
      background-position: center;
    }

    .album-art:hover {
      transform: scale(1.05);
    }

    .song-details {
      flex: 1;
      text-align: left;
    }

    .song-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 8px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
    }

    .artist-name {
      font-size: 1rem;
      opacity: 0.8;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
    }

    .visualizer-container {
      width: 100%;
      height: 65px;
      margin: 20px 0;
      display: flex;
      justify-content: center;
      align-items: flex-end;
      gap: 6px;
      padding: 0 20px;
    }

    .visualizer-bar {
      width: 6px;
      min-height: 2px;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 3px;
      transition: height 0.2s ease-out;
      will-change: height;
      position: relative;
    }

    .visualizer-bar::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #1ed760;
      border-radius: 3px;
      transform: scaleY(0);
      transform-origin: bottom;
      transition: transform 0.2s ease-out;
    }

    .visualizer-bar.active::before {
      transform: scaleY(1);
    }

    .controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      margin-bottom: 25px;
    }

    .control-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 50%;
      width: 45px;
      height: 45px;
      color: white;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: "JetBrains Mono", monospace;
      outline: none;
    }

    .control-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }

    .control-btn.active {
      background: rgba(30, 215, 96, 0.6);
    }

    .control-btn.active:hover {
      background: rgba(30, 215, 96, 0.8);
    }

    .play-btn {
      width: 60px;
      height: 60px;
      font-size: 1.5rem;
      background: rgba(30, 215, 96, 0.8);
    }

    .play-btn:hover {
      background: rgba(30, 215, 96, 1);
    }

    .progress-container {
      margin: 20px 0;
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 3px;
      overflow: hidden;
      cursor: pointer;
    }

    .progress {
      height: 100%;
      background: linear-gradient(90deg, #1db954, #1ed760);
      width: 0%;
      transition: width 0.1s ease;
      border-radius: 3px;
    }

    .time-info {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      opacity: 0.8;
      margin-top: 8px;
      font-weight: 400;
    }

    .playlist {
      position: fixed;
      right: 0;
      top: 0;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      border-radius: 10px 0 0 10px;
      padding: 20px;
      color: white;
      width: 300px;
      max-height: 100vh;
      overflow-y: auto;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      transform: translateX(100%);
      transition: transform 0.3s ease;
      z-index: 10;
    }

    .playlist.visible {
      transform: translateX(0);
    }

    .playlist h3 {
      margin-bottom: 15px;
      text-align: center;
      font-weight: 700;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    .playlist-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s ease;
      margin-bottom: 5px;
    }

    .playlist-item:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .playlist-item.active {
      background: rgba(30, 215, 96, 0.3);
    }

    .playlist-item .album-art-small {
      width: 40px;
      height: 40px;
      border-radius: 5px;
      object-fit: cover;
      background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.8rem;
      flex-shrink: 0;
      background-size: cover;
      background-position: center;
    }

    .playlist-item-info {
      flex: 1;
      min-width: 0;
    }

    .playlist-item-title {
      font-size: 0.8rem;
      font-weight: 700;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .playlist-item-artist {
      font-size: 0.7rem;
      opacity: 0.7;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .loading {
      text-align: center;
      opacity: 0.7;
      font-size: 0.9rem;
    }

    .error {
      color: #ff4444;
      text-align: center;
      font-size: 0.9rem;
    }

    .burger-menu {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      background: rgba(30, 215, 96, 0.8);
      border-radius: 50%;
      display: none;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      z-index: 100;
      transition: opacity 0.3s ease;
    }

    .burger-menu i {
      color: white;
      font-size: 1.2rem;
    }

    .burger-menu.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .playlist-trigger {
      position: fixed;
      right: 0;
      top: 0;
      width: 50px;
      height: 100%;
      z-index: 5;
    }

    .playlist::-webkit-scrollbar {
      width: 6px;
    }

    .playlist::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
    }

    .playlist::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 3px;
    }

    .playlist::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.5);
    }

    @media (max-width: 768px) {
      body {
        overflow: hidden;
        height: 100vh;
        min-height: -webkit-fill-available;
        background: linear-gradient(135deg, #1e3c72, #2a5298);
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .background-blur {
        filter: blur(15px) brightness(0.6);
        transform: scale(1.1);
      }

      .music-player {
        width: 90%;
        max-width: 400px;
        padding: 25px 20px;
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(8px);
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        position: relative;
        margin: 0;
      }

      .song-info {
        flex-direction: row;
        gap: 15px;
        margin-bottom: 20px;
      }

      .album-art {
        width: 100px;
        height: 100px;
        flex-shrink: 0;
      }

      .song-details {
        text-align: left;
      }

      .song-title {
        font-size: 1.3rem;
        margin-bottom: 5px;
      }

      .artist-name {
        font-size: 0.9rem;
      }

      .visualizer-container {
        height: 70px;
        margin: 15px 0;
      }

      .controls {
        gap: 10px;
        margin-bottom: 20px;
        justify-content: space-between;
        padding: 0 5px;
      }

      .control-btn {
        width: 42px;
        height: 42px;
        font-size: 0.9rem;
      }

      .play-btn {
        width: 55px;
        height: 55px;
        font-size: 1.3rem;
      }

      .progress-container {
        margin: 15px 0;
      }

      .playlist {
        width: 85%;
        padding-top: 60px;
        background: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(10px);
      }

      .playlist-item {
        padding: 12px 15px;
      }

      .burger-menu {
        display: flex;
      }

      @media (hover: none) {
        .control-btn:hover,
        .album-art:hover,
        .playlist-item:hover {
          transform: none !important;
          background: initial !important;
        }

        .play-btn:hover {
          transform: none !important;
          background: rgba(30, 215, 96, 0.8) !important;
        }
      }
    }

    @media (max-width: 400px) {
      .music-player {
        width: 95%;
        padding: 20px 15px;
      }

      .album-art {
        width: 80px;
        height: 80px;
      }

      .song-title {
        font-size: 1.1rem;
      }

      .artist-name {
        font-size: 0.8rem;
      }

      .controls {
        gap: 8px;
      }

      .control-btn {
        width: 38px;
        height: 38px;
      }

      .play-btn {
        width: 50px;
        height: 50px;
      }
    }
  </style>
  <body>
    <div class="background-blur" id="backgroundBlur"></div>
    <div class="overlay"></div>

    <div class="music-player">
      <div class="song-info">
        <div class="album-art" id="albumArt"></div>
        <div class="song-details">
          <div class="song-title" id="songTitle">Select a song</div>
          <div class="artist-name" id="artistName">No artist</div>
        </div>
      </div>

      <div class="visualizer-container" id="visualizer"></div>

      <div class="controls">
        <button class="control-btn" id="shuffleBtn" title="Shuffle">
          <i class="fas fa-random"></i>
        </button>
        <button class="control-btn" id="prevBtn" title="Previous">
          <i class="fas fa-backward"></i>
        </button>
        <button class="control-btn play-btn" id="playBtn" title="Play/Pause">
          <i class="fas fa-play"></i>
        </button>
        <button class="control-btn" id="nextBtn" title="Next">
          <i class="fas fa-forward"></i>
        </button>
        <button class="control-btn" id="repeatBtn" title="Repeat Off">
          <i class="fas fa-repeat"></i>
        </button>
      </div>

      <div class="progress-container">
        <div class="progress-bar" id="progressBar">
          <div class="progress" id="progress"></div>
        </div>
        <div class="time-info">
          <span id="currentTime">0:00</span>
          <span id="duration">0:00</span>
        </div>
      </div>
    </div>

    <div class="burger-menu" id="burgerMenu">
      <i class="fas fa-bars"></i>
    </div>

    <div class="playlist-trigger" id="playlistTrigger"></div>

    <div class="playlist" id="playlist">
      <h3>Playlist</h3>
      <div id="playlistContainer">
        <div class="loading">Loading music files...</div>
      </div>
    </div>

    <audio id="audioPlayer" preload="none"></audio>

    <script src="assets/script.js"></script>
  </body>
  <script>
    class MusicPlayer {
      constructor() {
        this.songs = [];
        this.currentSongIndex = 0;
        this.isPlaying = false;
        this.isShuffled = false;
        this.isNextButtonPressed = false;
        this.prevSongThreshold = 5;
        this.lastSongStartTime = 0;
        this.ignoreSeekThreshold = 2000;
        this.repeatMode = 0;
        this.shuffledIndices = [];
        this.currentShuffleIndex = 0;
        this.audioPlayer = document.getElementById("audioPlayer");
        this.audioContext = null;
        this.analyser = null;
        this.dataArray = null;
        this.source = null;
        this.animationId = null;

        // DOM elements
        this.playBtn = document.getElementById("playBtn");
        this.prevBtn = document.getElementById("prevBtn");
        this.nextBtn = document.getElementById("nextBtn");
        this.shuffleBtn = document.getElementById("shuffleBtn");
        this.repeatBtn = document.getElementById("repeatBtn");
        this.songTitle = document.getElementById("songTitle");
        this.artistName = document.getElementById("artistName");
        this.albumArt = document.getElementById("albumArt");
        this.backgroundBlur = document.getElementById("backgroundBlur");
        this.progress = document.getElementById("progress");
        this.progressBar = document.getElementById("progressBar");
        this.currentTimeEl = document.getElementById("currentTime");
        this.durationEl = document.getElementById("duration");
        this.playlistContainer = document.getElementById("playlistContainer");
        this.playlist = document.getElementById("playlist");
        this.burgerMenu = document.getElementById("burgerMenu");
        this.playlistTrigger = document.getElementById("playlistTrigger");
        this.visualizer = document.getElementById("visualizer");
        this.body = document.body;

        this.backgroundChangeInterval = null;
        this.backgroundImages = [
          "./image/background.jpg",
          "./image/background2.jpg",
          "./image/background3.jpg",
          "./image/background4.jpg",
          "./image/background5.jpg",
        ];
        this.currentBackgroundIndex = 0;
        this.backgroundPreloader = new Image();

        this.playlistVisible = false;
        this.playlistHovered = false;
        this.triggerHovered = false;

        this.init();
      }

      async init() {
        await this.loadMusicFiles();
        this.setupEventListeners();
        this.setupAudioEvents();
        this.initializeBackground();
        this.setupVisualizer();
        if (this.songs.length > 0) {
          this.updateSongDisplay();
          this.generateShuffledIndices();
        }
      }

      setupVisualizer() {
        this.visualizer.innerHTML = "";
        const barCount = 32;
        for (let i = 0; i < barCount; i++) {
          const bar = document.createElement("div");
          bar.className = "visualizer-bar";
          bar.style.height = `${Math.random() * 20 + 2}px`;
          this.visualizer.appendChild(bar);
        }

        this.visualizerBars = Array.from(
          this.visualizer.querySelectorAll(".visualizer-bar")
        );
      }

      setupAudioAnalysis() {
        if (!this.audioContext) {
          this.audioContext = new (window.AudioContext ||
            window.webkitAudioContext)();
          this.analyser = this.audioContext.createAnalyser();
          this.analyser.fftSize = 256;
          this.source = this.audioContext.createMediaElementSource(
            this.audioPlayer
          );
          this.source.connect(this.analyser);
          this.analyser.connect(this.audioContext.destination);
          this.dataArray = new Uint8Array(this.analyser.frequencyBinCount);
        }

        if (this.isPlaying) {
          this.animateVisualizer();
        }
      }

      animateVisualizer() {
        if (!this.analyser) return;

        this.analyser.getByteFrequencyData(this.dataArray);

        const binSkip = Math.floor(
          this.dataArray.length / this.visualizerBars.length
        );

        for (let i = 0; i < this.visualizerBars.length; i++) {
          const mirrorIndex = this.visualizerBars.length - 1 - i;
          const value =
            (this.dataArray[i * binSkip] +
              this.dataArray[mirrorIndex * binSkip]) /
              2 || 0;
          const height = Math.pow(value / 255, 0.7) * 80 + 2;
          const currentHeight =
            parseFloat(this.visualizerBars[i].style.height) || 2;
          const newHeight = currentHeight * 0.6 + height * 0.4;

          this.visualizerBars[i].style.height = `${newHeight}px`;
          this.visualizerBars[mirrorIndex].style.height = `${newHeight}px`;

          if (newHeight > 15) {
            this.visualizerBars[i].classList.add("active");
            this.visualizerBars[mirrorIndex].classList.add("active");
          } else {
            this.visualizerBars[i].classList.remove("active");
            this.visualizerBars[mirrorIndex].classList.remove("active");
          }
        }

        this.animationId = requestAnimationFrame(() =>
          this.animateVisualizer()
        );
      }

      stopVisualizer() {
        if (this.animationId) {
          cancelAnimationFrame(this.animationId);
          this.animationId = null;
        }

        if (this.visualizerBars) {
          this.visualizerBars.forEach((bar) => {
            bar.style.height = "2px";
            bar.classList.remove("active");
          });
        }
      }

      async initializeBackground() {
        if (this.backgroundImages.length > 0) {
          this.backgroundPreloader.src = this.backgroundImages[0];
          this.backgroundPreloader.onload = () => {
            this.backgroundBlur.style.backgroundImage = `url(${this.backgroundImages[0]})`;
            this.startBackgroundRotation();
          };
        }
      }

      startBackgroundRotation() {
        this.updateBackground();
        this.backgroundChangeInterval = setInterval(() => {
          this.updateBackground();
        }, 20000);
      }

      updateBackground() {
        if (this.backgroundImages.length === 0) return;

        const nextIndex =
          (this.currentBackgroundIndex + 1) % this.backgroundImages.length;
        const nextImage = new Image();
        nextImage.src = this.backgroundImages[nextIndex];

        nextImage.onload = () => {
          this.backgroundBlur.style.backgroundImage = `url(${
            this.backgroundImages[this.currentBackgroundIndex]
          })`;
          this.currentBackgroundIndex = nextIndex;
        };
      }

      generateShuffledIndices() {
        this.shuffledIndices = [...Array(this.songs.length).keys()];
        for (let i = this.shuffledIndices.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [this.shuffledIndices[i], this.shuffledIndices[j]] = [
            this.shuffledIndices[j],
            this.shuffledIndices[i],
          ];
        }
        this.currentShuffleIndex = this.shuffledIndices.indexOf(
          this.currentSongIndex
        );
      }

      toggleShuffle() {
        if (!this.isShuffled && this.repeatMode !== 0) {
          this.repeatMode = 0;
          this.repeatBtn.classList.remove("active");
          this.repeatBtn.title = "Repeat Off";
          this.repeatBtn.querySelector("i").className = "fas fa-repeat";
        }

        this.isShuffled = !this.isShuffled;
        this.shuffleBtn.classList.toggle("active", this.isShuffled);

        if (this.isShuffled) {
          this.generateShuffledIndices();
        }
      }

      toggleRepeat() {
        if (this.repeatMode === 0 && this.isShuffled) {
          this.isShuffled = false;
          this.shuffleBtn.classList.remove("active");
        }

        this.repeatMode = (this.repeatMode + 1) % 3;

        const icon = this.repeatBtn.querySelector("i");

        switch (this.repeatMode) {
          case 0:
            icon.className = "fas fa-repeat";
            this.repeatBtn.classList.remove("active");
            this.repeatBtn.title = "Repeat Off";
            break;
          case 1:
            icon.className = "fas fa-repeat";
            this.repeatBtn.classList.add("active");
            this.repeatBtn.title = "Repeat One";
            break;
          case 2:
            icon.className = "fas fa-arrow-right";
            this.repeatBtn.classList.add("active");
            this.repeatBtn.title = "Play Once";
            break;
        }
      }

      async loadMusicFiles() {
        try {
          const musicFiles = [
            {
              file: "CAS - Apocalypse.mp3",
              albumArt: "./image/album/cas.jpeg",
            },
            {
              file: "CAS - Cry.mp3",
              albumArt: "./image/album/cas.jpeg",
            },
            {
              file: "CAS - K..mp3",
              albumArt: "./image/album/cas.jpeg",
            },
            {
              file: "CAS - Sunsetz.mp3",
              albumArt: "./image/album/cas.jpeg",
            },
            {
              file: "Chezile - Beanie.mp3",
              albumArt: "./image/album/chezile.jpeg",
            },
            {
              file: "The Lantis - Bunga Maaf.mp3",
              albumArt: "./image/album/lantis.webp",
            },
            {
              file: "James Arthur - Car's Outside.mp3",
              albumArt: "./image/album/james.jpeg",
            },
            {
              file: "Mac DeMarco - Chamber Of Reflection.mp3",
              albumArt: "./image/album/mac.jpg",
            },
            {
              file: "Mac DeMarco - Moonlight On The River.mp3",
              albumArt: "./image/album/mac.jpg",
            },
            {
              file: "Coldplay - Trouble.mp3",
              albumArt: "./image/album/cold.jpeg",
            },
            {
              file: "Coldplay - Yellow.mp3",
              albumArt: "./image/album/cold.jpeg",
            },
            {
              file: "Sombr - Back to friends.mp3",
              albumArt: "./image/album/sombr.jpeg",
            },
            {
              file: "Henry Moodie - Drunk text.mp3",
              albumArt: "./image/album/henry.jpeg",
            },
            {
              file: "Yaeow - Favorite lesson.mp3",
              albumArt: "./image/album/yaeow.jpeg",
            },
            {
              file: "d4vd - Here With Me.mp3",
              albumArt: "./image/album/d4vd.jpeg",
            },
            {
              file: "d4vd - Romantic Homicide.mp3",
              albumArt: "./image/album/d4vd.jpeg",
            },
            {
              file: "Goo Goo Dolls - Iris.mp3",
              albumArt: "./image/album/goo.jpg",
            },
            {
              file: "RadioHead - Let Down.mp3",
              albumArt: "./image/album/radio.jpeg",
            },
            {
              file: "Feast - Nina.mp3",
              albumArt: "./image/album/feast.jpeg",
            },
            {
              file: "Feast - o,Tuan.mp3",
              albumArt: "./image/album/feast.jpeg",
            },
            {
              file: "Umay, Natania - Perayaan mati rasa.mp3",
              albumArt: "./image/album/umay.png",
            },
            {
              file: "Wave to earth - Seasons.mp3",
              albumArt: "./image/album/wave.jpeg",
            },
            {
              file: "Nuh.. - Teruntuk Mia.mp3",
              albumArt: "./image/album/nuh.png",
            },
            {
              file: "HYBS - Tip Toe.mp3",
              albumArt: "./image/album/hybs.jpeg",
            },
            {
              file: "Telephones - Vacations.mp3",
              albumArt: "./image/album/tele.png",
            },
            {
              file: "FUR - Walking Back Home.mp3",
              albumArt: "./image/album/fur.jpeg",
            },
            {
              file: "Dream, ivory - Welcome and Goodbye.mp3",
              albumArt: "./image/album/dream.jpeg",
            },
            {
              file: "Zach Templar - Missin something.mp3",
              albumArt: "./image/album/zach.jpeg",
            },
            {
              file: "Steve Lacy - Bad Habit.mp3",
              albumArt: "./image/album/steve.jpg",
            },
            {
              file: "Arctic Monkeys - I Wanna Be Yours (Instrumental).mp3",
              albumArt: "./image/album/am.png",
            },
            {
              file: "Sheila on 7 - Dan.mp3",
              albumArt: "./image/album/sheila.jpg",
            },
            {
              file: "Sheila on 7 - Film Favorit.mp3",
              albumArt: "./image/album/sheila.jpg",
            },
            {
              file: "Sheila On 7 - Sebuah Kisah Klasik.mp3",
              albumArt: "./image/album/sheila.jpg",
            },
          ];

          this.songs = [];

          for (const item of musicFiles) {
            try {
              const fileName = item.file;
              const filePath = "./music/" + fileName;
              const testAudio = new Audio();

              await new Promise((resolve, reject) => {
                testAudio.addEventListener("loadedmetadata", resolve);
                testAudio.addEventListener("error", reject);
                testAudio.src = filePath;
              });

              const songName = fileName.replace(/\.[^/.]+$/, "");
              const artistName = this.extractArtistFromFilename(songName);

              this.songs.push({
                title: this.formatSongTitle(songName),
                artist: artistName,
                src: filePath,
                duration: testAudio.duration,
                fileName: fileName,
                albumArt: item.albumArt || "./image/pfp.jpg",
              });
            } catch (error) {
              console.log(`Could not load ${item.file}:`, error.message);
            }
          }

          if (this.songs.length === 0) {
            this.playlistContainer.innerHTML = `
                <div class="error">
                  No music files found in ./music/ folder.<br>
                  Please add MP3 files to the music folder.
                </div>
              `;
            return;
          }

          this.renderPlaylist();
          console.log(`Loaded ${this.songs.length} songs:`, this.songs);
        } catch (error) {
          console.error("Error loading music files:", error);
          this.playlistContainer.innerHTML = `
              <div class="error">
                Error loading music files.<br>
                Make sure the music folder exists and contains audio files.
              </div>
            `;
        }
      }

      extractArtistFromFilename(filename) {
        const separators = [" - ", " _ ", "_", "-"];
        for (const sep of separators) {
          if (filename.includes(sep)) {
            return filename.split(sep)[0].trim();
          }
        }
        return "Unknown Artist";
      }

      formatSongTitle(filename) {
        const separators = [" - ", " _ ", "_", "-"];
        for (const sep of separators) {
          if (filename.includes(sep)) {
            return filename.split(sep).slice(1).join(sep).trim();
          }
        }
        return filename
          .replace(/[-_]/g, " ")
          .replace(/\b\w/g, (l) => l.toUpperCase());
      }

      renderPlaylist() {
        const playlistHTML = this.songs
          .map((song, index) => {
            return `
                <div class="playlist-item ${
                  index === this.currentSongIndex ? "active" : ""
                }" data-index="${index}">
                  <div class="album-art-small" style="background-image: url('${
                    song.albumArt
                  }')"></div>
                  <div class="playlist-item-info">
                    <div class="playlist-item-title">${song.title}</div>
                    <div class="playlist-item-artist">${song.artist}</div>
                  </div>
                </div>
              `;
          })
          .join("");

        this.playlistContainer.innerHTML = playlistHTML;

        this.playlistContainer
          .querySelectorAll(".playlist-item")
          .forEach((item) => {
            item.addEventListener("click", (e) => {
              const index = parseInt(e.currentTarget.dataset.index);
              this.selectSong(index);
              if (window.innerWidth <= 768) {
                this.togglePlaylist();
              }
            });
          });
      }

      formatTime(seconds) {
        if (isNaN(seconds) || seconds === Infinity) return "0:00";
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, "0")}`;
      }

      updateSongDisplay() {
        if (this.songs.length === 0) return;

        const song = this.songs[this.currentSongIndex];
        this.songTitle.textContent = song.title;
        this.artistName.textContent = song.artist;

        this.albumArt.style.backgroundImage = `url('${song.albumArt}')`;
        this.albumArt.style.backgroundSize = "cover";
        this.albumArt.style.backgroundPosition = "center";
        this.albumArt.textContent = "";

        this.durationEl.textContent = this.formatTime(song.duration);

        this.playlistContainer
          .querySelectorAll(".playlist-item")
          .forEach((item, index) => {
            item.classList.toggle("active", index === this.currentSongIndex);
          });
      }

      async selectSong(index) {
        if (index < 0 || index >= this.songs.length) return;

        const wasPlaying = this.isPlaying;

        if (this.isPlaying) {
          this.pause();
        }

        this.currentSongIndex = index;

        if (this.isShuffled) {
          this.currentShuffleIndex = this.shuffledIndices.indexOf(index);
        }

        const song = this.songs[this.currentSongIndex];
        this.audioPlayer.src = song.src;
        this.updateSongDisplay();

        if (this.audioContext && this.audioContext.state === "suspended") {
          await this.audioContext.resume();
        }
        this.setupAudioAnalysis();

        if (wasPlaying) {
          try {
            await this.audioPlayer.play();
            this.isPlaying = true;
            this.playBtn.innerHTML = '<i class="fas fa-pause"></i>';
            this.animateVisualizer();
          } catch (error) {
            console.error("Error playing audio:", error);
          }
        }
      }

      async togglePlay() {
        if (this.songs.length === 0) return;

        if (this.isPlaying) {
          this.pause();
        } else {
          await this.play();
        }
      }

      async play() {
        try {
          if (!this.audioPlayer.src) {
            this.audioPlayer.src = this.songs[this.currentSongIndex].src;
          }

          await this.audioPlayer.play();
          this.isPlaying = true;
          this.playBtn.innerHTML = '<i class="fas fa-pause"></i>';

          if (!this.audioContext) {
            this.setupAudioAnalysis();
          }
          this.animateVisualizer();
        } catch (error) {
          console.error("Error playing audio:", error);
          alert(
            "Cannot play this audio file. Please check if the file exists and is in a supported format."
          );
        }
      }

      pause() {
        this.audioPlayer.pause();
        this.isPlaying = false;
        this.playBtn.innerHTML = '<i class="fas fa-play"></i>';
        this.stopVisualizer();
      }

      async selectSong(index) {
        if (index < 0 || index >= this.songs.length) return;

        const wasPlaying = this.isPlaying;

        if (this.isPlaying) {
          this.pause();
        }

        this.currentSongIndex = index;
        this.lastSongStartTime = Date.now();

        const song = this.songs[this.currentSongIndex];
        this.audioPlayer.src = song.src;
        this.updateSongDisplay();

        if (this.audioContext && this.audioContext.state === "suspended") {
          await this.audioContext.resume();
        }
        this.setupAudioAnalysis();

        if (wasPlaying) {
          try {
            await this.audioPlayer.play();
            this.isPlaying = true;
            this.playBtn.innerHTML = '<i class="fas fa-pause"></i>';
            this.animateVisualizer();
          } catch (error) {
            console.error("Error playing audio:", error);
          }
        }
        this.lastSongStartTime = Date.now();
        this.lastSeekTime = 0;
      }

      prevSong() {
        if (this.songs.length === 0) return;

        const currentTime = this.audioPlayer.currentTime;
        const now = Date.now();
        const timeSinceSongStart = (now - this.lastSongStartTime) / 1000;
        const timeSinceLastSeek = this.lastSeekTime
          ? (now - this.lastSeekTime) / 1000
          : Infinity;

        if (timeSinceLastSeek < 2) {
          this.audioPlayer.currentTime = 0;
          this.updateProgress();
          if (this.isPlaying) {
            this.audioPlayer.play();
          }
          return;
        }

        if (currentTime > this.prevSongThreshold) {
          this.audioPlayer.currentTime = 0;
          this.updateProgress();
          this.lastSeekTime = Date.now();
          if (this.isPlaying) {
            this.audioPlayer.play();
          }
        } else {
          let prevIndex;

          if (this.isShuffled) {
            this.currentShuffleIndex =
              this.currentShuffleIndex > 0
                ? this.currentShuffleIndex - 1
                : this.shuffledIndices.length - 1;
            prevIndex = this.shuffledIndices[this.currentShuffleIndex];
          } else {
            prevIndex =
              this.currentSongIndex > 0
                ? this.currentSongIndex - 1
                : this.songs.length - 1;
          }

          this.selectSong(prevIndex);
        }
      }

      nextSong() {
        if (this.songs.length === 0) return;

        if (this.repeatMode === 1 && !this.isNextButtonPressed) {
          this.audioPlayer.currentTime = 0;
          if (this.isPlaying) {
            this.audioPlayer.play();
          }
          return;
        }

        this.isNextButtonPressed = false;

        let nextIndex;

        if (this.isShuffled) {
          this.currentShuffleIndex =
            this.currentShuffleIndex < this.shuffledIndices.length - 1
              ? this.currentShuffleIndex + 1
              : 0;
          nextIndex = this.shuffledIndices[this.currentShuffleIndex];
        } else {
          nextIndex =
            this.currentSongIndex < this.songs.length - 1
              ? this.currentSongIndex + 1
              : 0;
        }

        this.selectSong(nextIndex);
      }

      updateProgress() {
        if (this.audioPlayer.duration) {
          const progressPercent =
            (this.audioPlayer.currentTime / this.audioPlayer.duration) * 100;
          this.progress.style.width = `${progressPercent}%`;
          this.currentTimeEl.textContent = this.formatTime(
            this.audioPlayer.currentTime
          );
        }
      }

      handleProgressBarTouch(e) {
        if (this.audioPlayer.duration) {
          const rect = this.progressBar.getBoundingClientRect();
          const clickX = e.touches[0].clientX - rect.left;
          const width = rect.width;
          const newTime = (clickX / width) * this.audioPlayer.duration;
          this.audioPlayer.currentTime = newTime;
          e.preventDefault();
        }
      }

      togglePlaylist() {
        this.playlistVisible = !this.playlistVisible;
        this.playlist.classList.toggle("visible", this.playlistVisible);
        this.body.classList.toggle("playlist-open", this.playlistVisible);

        if (window.innerWidth <= 768) {
          if (this.playlistVisible) {
            const activeItem = this.playlistContainer.querySelector(
              ".playlist-item.active"
            );
            if (activeItem) {
              activeItem.scrollIntoView({
                behavior: "smooth",
                block: "center",
              });
            }
          }
        }
      }

      showPlaylist() {
        this.playlistVisible = true;
        this.playlist.classList.add("visible");
        this.body.classList.add("playlist-open");
        this.burgerMenu.classList.add("hidden");
      }

      hidePlaylist() {
        if (!this.playlistHovered && !this.triggerHovered) {
          this.playlistVisible = false;
          this.playlist.classList.remove("visible");
          this.body.classList.remove("playlist-open");
          this.burgerMenu.classList.remove("hidden");
        }
      }

      setupEventListeners() {
        this.playBtn.addEventListener("click", () => this.togglePlay());
        this.prevBtn.addEventListener("click", () => this.prevSong());

        this.nextBtn.addEventListener("click", () => {
          this.isNextButtonPressed = true;
          this.nextSong();
        });

        this.shuffleBtn.addEventListener("click", () => this.toggleShuffle());
        this.repeatBtn.addEventListener("click", () => this.toggleRepeat());

        this.progressBar.addEventListener("click", (e) => {
          if (this.audioPlayer.duration) {
            const clickX = e.offsetX;
            const width = this.progressBar.offsetWidth;
            const newTime = (clickX / width) * this.audioPlayer.duration;
            this.audioPlayer.currentTime = newTime;
          }
        });

        this.progressBar.addEventListener("touchstart", (e) => {
          this.handleProgressBarTouch(e);
        });

        this.progressBar.addEventListener("touchmove", (e) => {
          this.handleProgressBarTouch(e);
        });

        let touchStartX = 0;
        const playerContainer = document.querySelector(".music-player");

        playerContainer.addEventListener("touchstart", (e) => {
          touchStartX = e.touches[0].clientX;
        });

        playerContainer.addEventListener("touchend", (e) => {
          const touchEndX = e.changedTouches[0].clientX;
          const diffX = touchStartX - touchEndX;

          if (Math.abs(diffX) > 50) {
            if (diffX > 0) {
              this.nextSong();
            } else {
              this.prevSong();
            }
          }
        });

        this.burgerMenu.addEventListener("click", () => this.togglePlaylist());

        this.playlistTrigger.addEventListener("mouseenter", () => {
          this.triggerHovered = true;
          this.showPlaylist();
        });

        this.playlistTrigger.addEventListener("mouseleave", () => {
          this.triggerHovered = false;
          setTimeout(() => this.hidePlaylist(), 100);
        });

        this.playlist.addEventListener("mouseenter", () => {
          this.playlistHovered = true;
        });

        this.playlist.addEventListener("mouseleave", () => {
          this.playlistHovered = false;
          setTimeout(() => this.hidePlaylist(), 100);
        });

        document.addEventListener("keydown", (e) => {
          switch (e.code) {
            case "Space":
              e.preventDefault();
              this.togglePlay();
              break;
            case "ArrowLeft":
              this.prevSong();
              break;
            case "ArrowRight":
              this.nextSong();
              break;
            case "KeyS":
              if (e.ctrlKey || e.metaKey) {
                e.preventDefault();
                this.toggleShuffle();
              }
              break;
            case "KeyR":
              if (e.ctrlKey || e.metaKey) {
                e.preventDefault();
                this.toggleRepeat();
              }
              break;
          }
        });
      }

      setupAudioEvents() {
        this.audioPlayer.addEventListener("timeupdate", () => {
          this.updateProgress();
        });

        this.audioPlayer.addEventListener("ended", () => {
          if (this.repeatMode === 1) {
            this.audioPlayer.currentTime = 0;
            this.audioPlayer.play();
          } else if (this.repeatMode === 2) {
            if (
              (this.isShuffled &&
                this.currentShuffleIndex === this.shuffledIndices.length - 1) ||
              (!this.isShuffled &&
                this.currentSongIndex === this.songs.length - 1)
            ) {
              this.pause();
            } else {
              this.nextSong();
            }
          } else {
            this.nextSong();
          }
        });

        this.audioPlayer.addEventListener("loadedmetadata", () => {
          this.durationEl.textContent = this.formatTime(
            this.audioPlayer.duration
          );
        });

        this.audioPlayer.addEventListener("error", (e) => {
          console.error("Audio error:", e);
          this.pause();
        });
      }

      destroy() {
        if (this.backgroundChangeInterval) {
          clearInterval(this.backgroundChangeInterval);
        }
        this.stopVisualizer();
        if (this.audioContext) {
          this.audioContext.close();
        }
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      const player = new MusicPlayer();

      window.addEventListener("beforeunload", () => {
        player.destroy();
      });
    });
  </script>
</html>
